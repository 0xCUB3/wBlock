name: homebrew-cask

on:
  push:
    tags:
      - "v*"
      - "[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import Developer ID certificate
        env:
          MACOS_CERT_P12_B64: ${{ secrets.MACOS_CERT_P12_B64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -z "${MACOS_CERT_P12_B64:-}" ]]; then
            echo "Missing secret: MACOS_CERT_P12_B64" >&2
            exit 1
          fi
          if [[ -z "${MACOS_CERT_PASSWORD:-}" ]]; then
            echo "Missing secret: MACOS_CERT_PASSWORD" >&2
            exit 1
          fi

          KEYCHAIN_PATH="${RUNNER_TEMP}/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo "${MACOS_CERT_P12_B64}" | base64 --decode > "${RUNNER_TEMP}/cert.p12"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security list-keychains -d user -s "${KEYCHAIN_PATH}"

          security import "${RUNNER_TEMP}/cert.p12" -k "${KEYCHAIN_PATH}" -P "${MACOS_CERT_PASSWORD}" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"

      - name: Install provisioning profile
        env:
          MACOS_PROFILE_APP_B64: ${{ secrets.MACOS_PROFILE_APP_B64 }}
        run: |
          set -euo pipefail
          if [[ -z "${MACOS_PROFILE_APP_B64:-}" ]]; then
            echo "Missing secret: MACOS_PROFILE_APP_B64" >&2
            exit 1
          fi
          PP_DIR="${HOME}/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "${PP_DIR}"
          echo "${MACOS_PROFILE_APP_B64}" | base64 --decode > "${PP_DIR}/wBlock_DevID.provisionprofile"
          echo "Provisioning profile installed"

      - name: Build DMG
        run: |
          bash scripts/build-dmg.sh

      - name: Verify Gatekeeper assessment
        run: |
          set -euo pipefail
          app_path="build/homebrew/export/wBlock.app"
          echo "Running spctl assessment on ${app_path}..."
          spctl --assess --type execute -v "${app_path}"
          echo "Gatekeeper assessment passed"

      - name: Notarize + staple DMG
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_KEY_P8_B64: ${{ secrets.APPLE_API_KEY_P8_B64 }}
        run: |
          set -euo pipefail

          if [[ -z "${APPLE_API_KEY_ID:-}" ]]; then
            echo "Missing secret: APPLE_API_KEY_ID" >&2
            exit 1
          fi
          if [[ -z "${APPLE_API_ISSUER_ID:-}" ]]; then
            echo "Missing secret: APPLE_API_ISSUER_ID" >&2
            exit 1
          fi
          if [[ -z "${APPLE_API_KEY_P8_B64:-}" ]]; then
            echo "Missing secret: APPLE_API_KEY_P8_B64" >&2
            exit 1
          fi

          dmg="build/homebrew/wBlock.dmg"
          key_path="${RUNNER_TEMP}/AuthKey_${APPLE_API_KEY_ID}.p8"
          echo "${APPLE_API_KEY_P8_B64}" | base64 --decode > "${key_path}"

          notary_output=$(xcrun notarytool submit "${dmg}" \
            --key "${key_path}" \
            --key-id "${APPLE_API_KEY_ID}" \
            --issuer "${APPLE_API_ISSUER_ID}" \
            --wait 2>&1)
          echo "${notary_output}"

          uuid=$(echo "${notary_output}" | grep "  id:" | head -1 | awk '{print $2}')

          if echo "${notary_output}" | grep -q "status: Invalid"; then
            echo "Notarization failed. Fetching full log for UUID: ${uuid}"
            xcrun notarytool log "${uuid}" \
              --key "${key_path}" \
              --key-id "${APPLE_API_KEY_ID}" \
              --issuer "${APPLE_API_ISSUER_ID}"
            exit 1
          fi

          xcrun stapler staple "${dmg}"
          xcrun stapler validate "${dmg}"
          echo "Stapler validation passed"

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          dmg="build/homebrew/wBlock.dmg"

          # Ensure a release exists for this tag
          if ! gh release view "${tag}" >/dev/null 2>&1; then
            gh release create "${tag}" --title "${tag}" --notes ""
          fi

          # Upload/tagged asset
          gh release upload "${tag}" "${dmg}" --clobber

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain "${RUNNER_TEMP}/signing.keychain-db" || true
          rm -f "${HOME}/Library/MobileDevice/Provisioning Profiles/wBlock_DevID.provisionprofile" || true
